#! /usr/bin/env bash

set -e
set -u

if [ -f /usr/local/bin/aws ]; then
    exec /usr/local/bin/aws "$@"
else
    flock /tmp/awscli-install sh -c '
        mkdir -p /tmp/awscli
        cd /tmp/awscli
        curl -fsSL -o awscliv2.zip "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip"
        unzip -q awscliv2.zip
        ./aws/install > /dev/null
        cd -
        rm -rf /tmp/awscli
    ' 1>&2
    exec /usr/local/bin/aws "$@"
fi
